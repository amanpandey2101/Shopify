{% doc %}
  Renders a video element with all controls permanently removed.
{% enddoc %}

{% assign video_alt = video_alt | default: video.alt %}
{% assign alt = 'blocks.load_video' | t: description: video_alt | escape %}
{% assign video_preview_image = video_preview_image | default: video.preview_image %}
{% assign video_autoplay = true %}
{% assign video_loop = true %}
{% liquid
  assign media_width_desktop = 100 | divided_by: 2 | append: 'vw'
  assign media_width_mobile = '100vw'
  assign sizes = '(min-width: 750px) ' | append: media_width_desktop | append: ', ' | append: media_width_mobile
  assign widths = '450, 525, 600, 675, 750, 768, 850, 900, 1024, 1125, 1280, 1440, 1536, 1700, 1920, 2048, 2150, 2304, 2560, 2700, 2880, 3072, 3840, 4320, 5760'
%}

{% if video_from_url %}
  {% liquid
    if video_type == 'youtube'
      assign video_src = 'https://www.youtube.com/embed/' | append: video | append: '?controls=0&autoplay=1&loop=1&mute=1&playsinline=1&playlist=' | append: video
    else
      assign video_src = 'https://player.vimeo.com/video/' | append: video | append: '?background=1&autoplay=1&loop=1&muted=1'
    endif
  %}
  {% capture video_iframe %}
      <iframe
        src="{{ video_src }}"
        class="js-{{ video_type }}"
        allow="autoplay; encrypted-media"
        allowfullscreen
        title="{{ video_alt | escape }}"
      ></iframe>
  {% endcapture %}
{% else %}
  {% capture video_tag %}
    {% if video.host == 'youtube' %}
      {{
        video
        | external_video_url: autoplay: true, loop: true, playlist: video.external_id, mute: '1', controls: false
        | external_video_tag: data-video-type: 'youtube'
      }}
    {% elsif video.host == 'vimeo' %}
      {{
        video
        | external_video_url: autoplay: true, loop: true, muted: '1', controls: false
        | external_video_tag: data-video-type: 'vimeo'
      }}
    {% else %}
      {{ video | video_tag: image_size: '2500x', autoplay: true, loop: true, muted: true, controls: false, playsinline: true }}
    {% endif %}
  {% endcapture %}
{% endif %}

{% if video != blank %}
  <deferred-media
    class="{{ video_class }}"
    style="{{ video_style }}"
    autoplay
    {{ additional_attributes }}
  >
    {% if video_preview_image != blank %}
      {{
        video_preview_image
        | image_url: width: 1946
        | image_tag: widths: widths, sizes: sizes, loading: loading, class: 'deferred-media__poster-image'
      }}
    {% endif %}

    <template>
      {% if video_from_url %}
        {{ video_iframe }}
      {% else %}
        {{ video_tag }}
      {% endif %}
    </template>

    {% comment %} This block renders the video immediately since autoplay is forced {% endcomment %}
    {% if video_from_url %}
      {{ video_iframe }}
    {% else %}
      {{ video_tag }}
    {% endif %}
  </deferred-media>
{% else %}
  <div
    {{ additional_attributes }}
    class="{%- if video_class -%}{{ video_class }} {%- endif -%}video-placeholder-wrapper"
    style="{%- if video_style -%}{{ video_style }} {%- endif -%}--video-placeholder-width: {{ block.settings.custom_width | default: 100 }}%;"
  >
    {% if video_preview_image != blank %}
      {{ video_preview_image | image_url: width: 1946 | image_tag: widths: widths, sizes: sizes, loading: loading }}
    {% else %}
      <placeholder-image
        class="placeholder-video"
        data-block-id="{{ section_id }}-{{ block.id }}"
        data-type="general"
      ></placeholder-image>
    {% endif %}
  </div>
{% endif %}